name: Update Jira Release Notes

on:
  pull_request:
    types: [closed]

jobs:
  update-release-notes:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Extract branch name
        id: extract
        run: |
          echo "branch=${GITHUB_HEAD_REF}" >> $GITHUB_OUTPUT

      - name: Extract Jira issue key from branch
        id: issue
        run: |
          BRANCH="${{ steps.extract.outputs.branch }}"

          # Regex to extract FIRST TWO WORDS: PROJECT + NUMBER
          if [[ "$BRANCH" =~ ([A-Z]+-[0-9]+) ]]; then
            ISSUE_KEY="${BASH_REMATCH[1]}"
            echo "key=$ISSUE_KEY" >> $GITHUB_OUTPUT
            echo "Detected Issue Key: $ISSUE_KEY"
          else
            echo "Error: No Jira issue key found in branch name $BRANCH"
            exit 1
          fi


      - name: Generate Release Notes using GPT
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          echo "Fetching PR diff for PR #$PR_NUMBER"

          DIFF=$(curl -s \
            -H "Accept: application/vnd.github.v3.diff" \
            https://api.github.com/repos/$REPO/pulls/$PR_NUMBER)

          # Trim diff to reasonable size (optional)
          SAFE_DIFF=$(echo "$DIFF" | head -c 30000)

          echo "DIFF SIZE: ${#SAFE_DIFF} characters"

          # Build JSON payload using jq to properly escape special characters
          PAYLOAD=$(jq -n \
            --arg diff "$SAFE_DIFF" \
            '{
              "model": "gpt-4o-mini",
              "messages": [
                {
                  "role": "system",
                  "content": "You generate clear release notes from code changes."
                },
                {
                  "role": "user",
                  "content": ("Create detailed release notes based ONLY on these code changes.\n\n" + $diff + "\n\nInclude:\n- WHY the change was needed\n- WHAT was implemented\n- HOW it affects behavior\n- Technical details\n- Files modified\n- Impact and testing notes.")
                }
              ]
            }')

          RAW_RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "RAW_RESPONSE = $RAW_RESPONSE"

          RESPONSE=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content // "No content generated"')

          echo "Final RESPONSE = $RESPONSE"

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      - name: Update Jira Issue
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          ISSUE_KEY: ${{ steps.issue.outputs.key }}
        run: |
          curl -u $JIRA_EMAIL:$JIRA_API_TOKEN \
            -X POST \
            -H "Content-Type: application/json" \
            --data "{
              \"body\": {
                \"type\": \"doc\",
                \"version\": 1,
                \"content\": [{
                  \"type\": \"paragraph\",
                  \"content\": [{
                    \"type\": \"text\",
                    \"text\": \"${{ steps.generate.outputs.notes }}\"
                  }]
                }]
              }
            }" \
            $JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY/comment
