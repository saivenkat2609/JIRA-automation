name: Update Jira Release Notes

on:
  pull_request:
    types: [closed]

jobs:
  update-release-notes:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Extract branch name
        id: extract
        run: |
          echo "branch=${GITHUB_HEAD_REF}" >> $GITHUB_OUTPUT

      - name: Extract Jira issue key from branch
        id: issue
        run: |
          BRANCH="${{ steps.extract.outputs.branch }}"

          # Regex to extract FIRST TWO WORDS: PROJECT + NUMBER
          if [[ "$BRANCH" =~ ([A-Z]+-[0-9]+) ]]; then
            ISSUE_KEY="${BASH_REMATCH[1]}"
            echo "key=$ISSUE_KEY" >> $GITHUB_OUTPUT
            echo "Detected Issue Key: $ISSUE_KEY"
          else
            echo "Error: No Jira issue key found in branch name $BRANCH"
            exit 1
          fi


      - name: Generate Release Notes using GPT
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          echo "Fetching PR diff for PR #$PR_NUMBER"

          DIFF=$(curl -s \
            -H "Accept: application/vnd.github.v3.diff" \
            https://api.github.com/repos/$REPO/pulls/$PR_NUMBER)

          # Trim diff to reasonable size (optional)
          SAFE_DIFF=$(echo "$DIFF" | head -c 30000)

          echo "DIFF SIZE: ${#SAFE_DIFF} characters"

          # Build JSON payload using jq to properly escape special characters
          PAYLOAD=$(jq -n \
            --arg diff "$SAFE_DIFF" \
            '{
              "model": "gpt-4o-mini",
              "messages": [
                {
                  "role": "system",
                  "content": "You generate structured release notes from code changes. Always respond with valid JSON only, no markdown formatting."
                },
                {
                  "role": "user",
                  "content": ("Analyze these code changes and generate release notes in JSON format with these exact fields:\n\n" + $diff + "\n\nRespond with ONLY a JSON object (no markdown, no code blocks) with these fields:\n{\n  \"heading\": \"Brief title for the release (5-10 words)\",\n  \"why\": \"Why was this change needed? What problem does it solve?\",\n  \"what\": \"What was implemented? Describe the solution and technical details.\",\n  \"how\": \"How can users access or use this feature? What are the steps?\",\n  \"impact\": \"What is the impact? How does this affect users, system, or behavior?\"\n}")
                }
              ],
              "response_format": { "type": "json_object" }
            }')

          RAW_RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "RAW_RESPONSE = $RAW_RESPONSE"

          RESPONSE=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content // "{}"')

          echo "Parsed JSON RESPONSE = $RESPONSE"

          # Extract individual fields from JSON response
          HEADING=$(echo "$RESPONSE" | jq -r '.heading // "Release Update"')
          WHY=$(echo "$RESPONSE" | jq -r '.why // "No information provided"')
          WHAT=$(echo "$RESPONSE" | jq -r '.what // "No information provided"')
          HOW=$(echo "$RESPONSE" | jq -r '.how // "No information provided"')
          IMPACT=$(echo "$RESPONSE" | jq -r '.impact // "No information provided"')

          # Save to outputs
          echo "heading=$HEADING" >> $GITHUB_OUTPUT
          echo "why<<EOF" >> $GITHUB_OUTPUT
          echo "$WHY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "what<<EOF" >> $GITHUB_OUTPUT
          echo "$WHAT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "how<<EOF" >> $GITHUB_OUTPUT
          echo "$HOW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "impact<<EOF" >> $GITHUB_OUTPUT
          echo "$IMPACT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      - name: Update Jira Custom Fields
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          ISSUE_KEY: ${{ steps.issue.outputs.key }}
        run: |
          # Use heredoc to safely capture each field
          HEADING=$(cat << 'EOF'
          ${{ steps.generate.outputs.heading }}
          EOF
          )

          WHY=$(cat << 'EOF'
          ${{ steps.generate.outputs.why }}
          EOF
          )

          WHAT=$(cat << 'EOF'
          ${{ steps.generate.outputs.what }}
          EOF
          )

          HOW=$(cat << 'EOF'
          ${{ steps.generate.outputs.how }}
          EOF
          )

          IMPACT=$(cat << 'EOF'
          ${{ steps.generate.outputs.impact }}
          EOF
          )

          # Build JIRA update payload using jq to properly escape special characters
          JIRA_PAYLOAD=$(jq -n \
            --arg heading "$HEADING" \
            --arg why "$WHY" \
            --arg what "$WHAT" \
            --arg how "$HOW" \
            --arg impact "$IMPACT" \
            '{
              "fields": {
                "customfield_10265": $heading,
                "customfield_10358": $why,
                "customfield_10359": $what,
                "customfield_10361": $how,
                "customfield_10362": $impact
              }
            }')

          echo "Updating JIRA issue $ISSUE_KEY with custom fields"
          echo "Payload: $JIRA_PAYLOAD"

          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -u $JIRA_EMAIL:$JIRA_API_TOKEN \
            -X PUT \
            -H "Content-Type: application/json" \
            --data "$JIRA_PAYLOAD" \
            $JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY)

          HTTP_CODE=$(echo "$RESPONSE" | grep HTTP_CODE | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE/d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Successfully updated JIRA custom fields!"
          else
            echo "Failed to update JIRA. Status: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
